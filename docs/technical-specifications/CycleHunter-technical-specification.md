# Технічна специфікація: CycleHunter

## 1. Загальні положення

**Назва проєкту:** CycleHunter

**Мета:** Розробка CLI-інструменту для моніторингу балансів акаунта Binance та виявлення, розрахунку прибутковості та бектестування можливостей арбітражу на криптовалютній біржі Binance.

**Основна технологія:** Python 3.9+

**Біржа:** Binance (Spot Market)

## 2. Функціональні вимоги

### 2.1. Моніторинг балансу

#### 2.1.1. Команда `balance get`

- **Отримання балансів:**
  - Скрипт підключається до API Binance для отримання балансів Spot, Futures та Earn.
  - Використовуються наступні ендпоінти Binance API:
    - `get_account()` для отримання балансу Spot.
    - `futures_account_balance()` для отримання балансу Futures.
    - `get_lending_position()` для отримання балансу Earn.
- **Розрахунок вартості:**
  - Для кожного активу розраховується його вартість в USD. Для цього використовується поточна ціна пари `[ASSET]USDT`.
- **Фільтрація:**
  - Зі списку виключаються активи вартістю менше $1.
- **Відображення:**
  - В консоль виводиться загальний баланс в USD, а також баланси для кожного типу гаманця (Spot, Futures, Earn).
- **Збереження:**
  - Результат зберігається у файлах `output/balance_output.json` та `output/balance_output.txt`.

#### 2.1.2. Команда `balance monitor`

- **Безперервний моніторинг:**
  - Скрипт безперервно отримує та зберігає баланси кожні 60 секунд.
- **Логування:**
  - В консоль виводиться час останнього оновлення.
- **Зупинка:**
  - Роботу скрипта можна зупинити комбінацією клавіш `Ctrl+C`.

### 2.2. Арбітраж

#### 2.2.1. Модуль конфігурації

- **Файл конфігурації:** `configs/config.json`.
- **Параметри:**
    - `base_currency`: Основна валюта для пошуку циклів (наприклад, "USDT").
    - `trading_fee`: Комісія за торгівлю. Використовується як значення за замовчуванням, якщо неможливо отримати комісію для конкретної пари.
    - `min_profit_threshold`: Мінімальний відсоток прибутку для запису в лог прибуткових циклів.
    - `max_cycle_length`: Максимальна кількість монет у арбітражному циклі.
    - `monitored_coins`: Список монет для моніторингу.

#### 2.2.2. Модуль пошуку циклів (`arbitrage find-cycles`)

- **Алгоритм:** Використовує алгоритм пошуку в глибину (DFS) для знаходження всіх можливих циклів, що починаються і закінчуються `base_currency`.
- **Фільтрація пар:**
    - Враховуються тільки ті торгові пари, які існують на Binance і складаються з монет, вказаних у `monitored_coins` та `base_currency`.
    - Додатково перевіряється статус пари. Враховуються тільки пари зі статусом `TRADING`.
- **Збереження результатів:**
    - Знайдені цикли зберігаються у файлах `configs/possible_cycles.json` та `configs/possible_cycles.txt`.

#### 2.2.3. Модуль моніторингу прибутковості (`arbitrage run-monitor`)

- **Отримання даних:**
    - Підключається до Binance API через WebSocket для отримання ринкових даних (`@bookTicker` stream) у реальному часі для всіх пар, що беруть участь у знайдених циклах.
- **Розрахунок прибутковості:**
    - Для кожного циклу безперервно виконується розрахунок потенційного прибутку.
    - **Формула розрахунку:**
        1.  Початкова сума = 1 `base_currency`.
        2.  Для кожного кроку в циклі:
            -   Якщо відбувається купівля базового активу, використовується ціна **Ask**.
            -   Якщо відбувається продаж базового активу, використовується ціна **Bid**.
            -   Враховується торгова комісія: `сума = сума * (1 - trading_fee)`.
        3.  `profit_pct = ((кінцева_сума - 1) / 1) * 100`.
- **Логування:**
    - Усі розраховані прибутки (позитивні та негативні) записуються в `output/all_profits.txt` та `output/all_profits.json` кожні 2 секунди.
    - Якщо `profit_pct` > `min_profit_threshold`, цикл записується в `output/profits.txt`.

#### 2.2.4. Модуль бектестування (`arbitrage backtest`)

- **Отримання історичних даних:**
    - Завантажує історичні дані (1-хвилинні K-лінії) для всіх необхідних торгових пар за вказаний період часу.
    - Використовує `get_historical_klines` з бібліотеки `python-binance`.
- **Симуляція:**
    - Ітерується по кожній хвилині історичних даних.
    - Для кожної хвилини розраховує прибутковість всіх циклів, використовуючи ціну закриття (`close price`) як для `ask`, так і для `bid`.
- **Результати:**
    - Прибуткові цикли (вище `min_profit_threshold`) записуються у файл `logs/backtest_results.log`.

## 3. Нефункціональні вимоги

- **Продуктивність:** Використання WebSockets для отримання цін в реальному часі.
- **Надійність:** Обробка помилок з'єднання з API та спроби перепідключення.
- **Конфігурованість:** Всі ключові параметри винесені в конфігураційні файли.
- **Безпека:** API ключі зберігаються у файлі `.env`.
- **Зручність:** Інструмент повинен бути простим у використанні з командного рядка.

## 4. Стек технологій та бібліотек

- **Мова програмування:** Python 3.9+
- **Основні бібліотеки:**
  - `python-binance`: для взаємодії з API Binance.
  - `websockets`: для отримання даних у реальному часі.
  - `asyncio`: для асинхронної обробки даних.
  - `python-dotenv`: для завантаження змінних середовища з `.env` файлу.